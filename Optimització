global fermentduration interpolatedSugar realtime  ;

timeaddition0=200;
Nadd0=0.05;
Nadd=Nadd0;
timeaddition=timeaddition0;



% Definim funció objectiu
objective = @(params) objectiveFunction(params(1), params(2));

% Valors inicial de les variables d'optimització
initial_params = [Nadd0, timeaddition0];

% Optimització amb l'algoritme fminsearch
options = optimset('Display', 'iter', 'MaxIter', 30);
[optimal_params, fval] = fminsearch(objective, initial_params, options);

% Extracció dels valors optimitzats
optimized_Nadd = optimal_params(1);
optimized_timeaddition = optimal_params(2);

% Imprimir valors de l'optimització
disp('Optimized Parameters:');
disp(['Optimized Nadd: ', num2str(optimized_Nadd)]);
disp(['Optimized timeaddition: ', num2str(optimized_timeaddition)]);
disp(['Objective value: ', num2str(fval)]);

% ús dels valors optimitzats per corre la simulació i imprimir els resultats
Nadd = optimized_Nadd;
timeaddition = round(optimized_timeaddition);

%reset de les matrius
solution=[];
time=[];

% Run de la simulació
[solution,time] = runSimulation(Nadd, timeaddition);

% Operació per fer coincidir size de les dades reals amb el size de la simulació
interpolatedSugar = interp1(realtime, sugar, time);


%Imprimir simulació optimitzada

yyaxis left
subplot(2,1,1)
plot(time, solution(:,1), 'b-')

hold on;

plot(time,interpolatedSugar,'r--');

xlabel('Time (h)');
ylabel('S (g/L) ');

xlim([min(time), max(time)]);

hold off;

yyaxis right
subplot(2,1,1)
plot (time,solution(:,3),'g-');
legend ('S simulated','S real','X');
ylabel ('X (n cell/L)');

yyaxis left
subplot(2,1,2)
plot(time,solution(:,2),'r-')
legend ('N');
xlabel('Time (h)');
ylabel('N (g/L)');
text(400, 0.2, ['Simulated ferment time: ', num2str(round(time(end)/24)),' days']);
text(400,0.15,['Real ferment time: ', num2str(fermentduration),' days'])

% Funció per corre la simulació
function [solution,time] = runSimulation(Nadd, timeaddition)
    
    global S0 Ninit Xinit 

    solution = [];
    time = [];
    t_start = 0;
    t_end = 1;
    tspan = [t_start, t_end];

    S_0 = S0;
    N_0 = Ninit;
    X_0 = Xinit;
    y0 = [S_0, N_0, X_0];

    % solver edo per trobar temps de simulació
    while true
        [t, y] = ode45(@(t, y) miode(t, y, Nadd, timeaddition), tspan, y0);

        % Acumulador de solucions
        solution = [solution; y];
        time = [time; t];

        % Check condition
        if y(end, 1) <= (0.02 * S0)
            break;

        end

        %if de seguretat per evitar loops infinits
        if t>1000
            break
        end


        % Redifinició de tspan
        t_start = t(end);
        t_end = t(end) + 1;
        tspan = [t_start, t_end];

        % Condició per considerar adicions.
        if t_start == timeaddition
            N_0 = Nadd;
        else
            N_0 = y(end, 2);
        end

        S_0 = y(end, 1);
        X_0 = y(end, 3);
        y0 = [S_0, N_0, X_0];
    end
    
    % Retornar valors de la simulació.
    y = solution;
    t=time;
end


%Funció per generar la ObjectiveFunction
function objective = objectiveFunction(Nadd, timeaddition)
 
    solution=[];
    time=[];
    
   % Aplicador de limits de seguretat
    Nadd_lb = 0.001; % Limit inferior per Nadd
    Nadd_ub = 0.065; % Limit superor per Nadd

    timeaddition_lb = 24; % limit inferior per timeaddition
    timeaddition_ub = 500; % limit superior per timeaddition
    
    % Aproximar valor per obtenir numeros enters
    rounded_timeaddition = round(timeaddition);

    % Aplicació dels limits per timeaddition
    timeaddition = max(min(rounded_timeaddition, timeaddition_ub), timeaddition_lb)

    % Aplicació dels limits per Nadd
    Nadd = max(min(Nadd, Nadd_ub), Nadd_lb);


    % Corre la simulació amb els nous valors de Nadd i timeaddition
    [solution,time] = runSimulation(Nadd, timeaddition);

  
    objective=time(end)
   
end
